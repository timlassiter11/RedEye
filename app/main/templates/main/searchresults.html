{% extends "main/layout.html" %}

{% block styles %}
{{ super() }}
<style>
    .flightPath {
        /* Give some buffer on the ends or else the line can show past the end markers*/
        width: calc(100% - 4px);
        position: absolute;
        height: 2px;
        left: 2px;
        background-color: black;
        top: calc(50% - 1px);
    }

    .pathMarker {
        height: 8px;
        width: 8px;
        background-color: black;
    }

    .pathText {
        min-width: 50px;
        margin-bottom: 0;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="overlay-parent flex-grow-1 content-background">
    <div id="loadingScreen" class="overlay-content vstack justify-content-center fade show bg-white">
        <div class="my-auto">
            <div class="text-center">
                <div class="spinner-grow text-redeye" style="width: 2rem; height: 2rem; animation-delay: 0ms;"
                    role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="spinner-grow text-redeye" style="width: 2rem; height: 2rem; animation-delay: 150ms;"
                    role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="spinner-grow text-redeye" style="width: 2rem; height: 2rem; animation-delay: 300ms;"
                    role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>
    <div id="contentContainer" class="container mt-3 d-none" style="max-width: 938px;">
        <h2>{{ departure.code }}<i class="bi bi-arrow-right-short"></i>{{ arrival.code }}</h2>
        <h5>{{ date.strftime("%a, %b %d, %Y") }}</h5>
        <div id="noFlightsMessage" class="content-card p-3 d-none mt-3">
            <p class="fw-bold my-2">Unfortunately, no flights meet your search criteria.</p>
        </div>
        <div id="resultContainer" class="mx-md-5 mt-4"></div>
    </div>
</div>
<template id="resultRow">
    <div class="row gx-0 mb-3 content-card">
        <div class="col me-md-5 mb-3 mb-md-0">
            <div class="d-flex flex-nowrap" name="topRow">
                <p class="flex-grow-1" name="flightNumbers"></p>
                <p name="tripTime"></p>
            </div>
            <div class="d-flex flex-nowrap justify-content-between mb-3">
                <h4 class="d-inline-block" name="departureTime"></h4>
                <!-- <h4 class="d-inline-block"><i class="bi bi-arrow-right-short"></i></h4> -->
                <h4 class="d-inline-block" name="arrivalTime"></h4>
            </div>
            <div name="layoverContainer" class="d-flex flex-nowrap justify-content-between"></div>
            <div name="markerContainer" class="d-flex flex-nowrap justify-content-between position-relative">
                <div class="flightPath"></div>
            </div>
            <div name="airportContainer" class="d-flex flex-nowrap justify-content-between"></div>
        </div>
        <hr class="d-md-none">
        <div class="vr d-none d-md-block"></div>
        <div class="col-md-4 ms-md-5 mt-3 mt-md-0 ">
            <div class="d-flex flex-column justify-content-center h-100">
                <h4 class="text-center" name="cost"></h4>
                <button name="book" class="btn btn-redeye" type="button">Book Now</button>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="/static/scripts/luxon.min.js"></script>
<script>
    function strToDuration(str) {
        // Format = 1 days, 1:23:45
        const obj = {}

        let parts = str.split(',');
        if (parts.length === 2) {
            let days = parts.shift();
            obj.days = days.split(' ')[0];
        }

        parts = parts[0].split(':');

        obj.hours = parts[0];
        obj.minutes = parts[1];
        obj.seconds = parts[2];

        return luxon.Duration.fromObject(obj).shiftTo('hours', 'minutes');
    }

    $(document).ready(function () {
        $.ajax({
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            url: "{{ url_for('api.flightsearch', **args)|safe }}",
            type: 'GET',
            success: function (response, textStatus, jqXhr) {
                if (response._meta.total_items === 0) {
                    // TODO: Display something when no available flights are found.
                    $('#noFlightsMessage').removeClass('d-none');
                    searchCollapse.show();
                } else {
                    for (const i in response.items) {
                        const item = response.items[i];
                        const template = document.querySelector('#resultRow');
                        const row = template.content.cloneNode(true);
                        const $row = $(row);

                        const departure_dt = luxon.DateTime.fromISO(item.departure_datetime, { setZone: true });
                        const arrival_dt = luxon.DateTime.fromISO(item.arrival_datetime, { setZone: true });

                        const $departureTime = $row.find('[name="departureTime"]');
                        const $arrivalTime = $row.find('[name="arrivalTime"]');

                        $departureTime.text(departure_dt.toFormat('hh:mm a'));
                        $arrivalTime.text(arrival_dt.toFormat('hh:mm a'));

                        if (departure_dt.get('day') < arrival_dt.get('day')) {
                            $row.find('[name="topRow"]').append('<i class="bi bi-eye-fill text-redeye"></i>');
                        }

                        const $markerContainer = $row.find('[name="markerContainer"]');
                        const $airportContainer = $row.find('[name="airportContainer"]');
                        const $layoverContainer = $row.find('[name="layoverContainer"]');

                        let flightNumbers = '';
                        let flight = null;
                        let previousFlight = null;
                        let current_dt = departure_dt.setZone('utc');
                        for (const j in item.flights) {

                            flight = item.flights[j];

                            if (previousFlight !== null) {
                                const parts = flight.departure_time.split(':');

                                let nextDeparture = current_dt.set({
                                    hour: parts[0],
                                    minute: parts[1]
                                });

                                // Handle layover rolling over midnight
                                if (nextDeparture < current_dt) {
                                    nextDeparture = nextDeparture.plus(luxon.Duration.fromObject({ hours: 24 }));
                                }

                                const layover = nextDeparture.diff(current_dt, ['hours', 'minutes']);
                                current_dt = current_dt.plus(layover);
                                $layoverContainer.append(`<p class="pathText"><small>${layover.toFormat("h'h'm'm'")}<small></p>`);
                            } else {
                                $layoverContainer.append('<div class="pathText"></div>');
                            }

                            previousFlight = flight;
                            const flightTime = strToDuration(flight.flight_time);
                            current_dt = current_dt.plus(flightTime);

                            flightNumbers += `RE${flight.number} / `;

                            $markerContainer.append('<div class="pathMarker"></div>');
                            $airportContainer.append(`<p>${flight.departure_airport.code}</p>`)
                        }

                        // Add the final stop
                        $layoverContainer.append('<div class="pathText"></div>');
                        $markerContainer.append('<div class="pathMarker"></div>');
                        $airportContainer.append(`<p>${flight.arrival_airport.code}</p>`)

                        // Remove the extra "/ " from the end.
                        flightNumbers = flightNumbers.slice(0, flightNumbers.length - 2);
                        const $flightNumbers = $row.find('[name="flightNumbers"]');
                        $flightNumbers.text(flightNumbers);


                        const $tripTime = $row.find('[name="tripTime"]');
                        const tripTime = strToDuration(item.total_time);
                        $tripTime.text(tripTime.toFormat("h'h'm'm'"));

                        const $cost = $row.find('[name="cost"]');
                        const cost = item.cost.toFixed(2);
                        $cost.text(`\$${cost}`);

                        $row.find('[name="book"]').click((event) => {
                            window.sessionStorage.setItem("itinerary", JSON.stringify(item));
                            window.sessionStorage.setItem("passengers", "{{ args.get('num_of_passengers') }}");
                            window.location = "{{ url_for('main.checkout') }}";
                        });

                        $('#resultContainer').append(row);
                    }
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                // TODO: How should we handle errors?
                const response = jqXHR.responseJSON
            },
            complete: function () {
                $('#contentContainer').removeClass('d-none');
                $('#loadingScreen').removeClass('show');
                setTimeout(function() {
                    $('#loadingScreen').hide();
                }, 150);
            }
        })
    })
</script>
{% endblock %}